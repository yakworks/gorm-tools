apply plugin:"war"
apply plugin:"org.grails.grails-web"
apply plugin:"org.grails.plugins.views-json"

repositories {
  maven { url "https://build.shibboleth.net/nexus/content/repositories/releases/" } //for pac4j deps
}

//use common loggin in root
// sourceSets.main.resources.srcDirs += "../../logback"

dependencies {
  console "org.grails:grails-console"
  profile "org.grails.profiles:rest-api"
  implementation("org.springframework.boot:spring-boot-starter-actuator"){ exclude module: 'micrometer-core' }

  implementation "org.grails:grails-plugin-i18n"
  implementation "org.grails:grails-plugin-rest"
  implementation "org.grails:grails-plugin-url-mappings"
  implementation "org.grails:grails-plugin-codecs"
  implementation "org.grails:grails-plugin-interceptors"
  implementation "org.grails:grails-web-boot"
  implementation "org.grails:grails-web-url-mappings"
  implementation "org.grails.plugins:async"

  implementation "org.grails.plugins:views-json:$vViews"
  implementation "org.grails.plugins:views-json-templates:$vViews"

  implementation "org.grails.plugins:hibernate5:$vGormHibernate"
  implementation "org.hibernate:hibernate-core:$vHibernate"
  // compile "org.hibernate:hibernate-ehcache:$vHibernate"

  implementation project(":gorm-tools-security")
  implementation project(":gorm-tools-rest")
  implementation project(":rally-domain")
  implementation project(":rally-security")

  //Hazelcast
  runtimeOnly "com.hazelcast:hazelcast-hibernate53:$vHazelcastHib"
  runtimeOnly "com.hazelcast:hazelcast:$vHazelcast"
  runtimeOnly "com.hazelcast:hazelcast-spring:$vHazelcast"
  //compatible micrometer
  // compile "io.micrometer:micrometer-core:1.5.0"

  //??wtf
  implementation "commons-lang:commons-lang:2.6"
  // runtimeOnly "org.grails.plugins:external-config:$vExternalConfig"
  runtimeOnly "dk.glasius:external-config:$vExternalConfig"

  // dk.glasius not working, load twice
  // runtimeOnly "org.grails.plugins:external-config:$vExternalConfig"
  runtimeOnly "dk.glasius:external-config:$vExternalConfig"
  runtimeOnly "com.h2database:h2:$vH2"
  runtimeOnly "javax.xml.bind:jaxb-api:2.3.1"
  runtimeOnly "com.zaxxer:HikariCP:$vHikari"

  //for rest api testing
  testImplementation "com.squareup.okhttp3:okhttp:$vOkhttp"
  //okhttp3 needs this
  testImplementation "org.jetbrains.kotlin:kotlin-stdlib:$vKotlin"
}

bootRun {
  //  ignoreExitValue true
  jvmArgs('-Dspring.output.ansi.enabled=always', '-noverify', '-XX:TieredStopAtLevel=1', '-Xmx1024m')
  sourceResources sourceSets.main
  String springProfilesActive = 'spring.profiles.active'
  systemProperty springProfilesActive, System.getProperty(springProfilesActive)
  //fix hazel cast Not supported: "http://javax.xml.XMLConstants/property/accessExternalDTD"
  // FIXME the pac4j dependency adds some XML lib that is screwing this up
  // systemProperty 'hazelcast.ignoreXxeProtectionFailures', true
}

bootJar.enabled = true
bootJar.archiveFileName = 'restify.jar'

integrationTest.doFirst {
  //fix hazel cast Not supported: "http://javax.xml.XMLConstants/property/accessExternalDTD"
  // FIXME the pac4j dependency adds some XML lib that is screwing this up
  systemProperty 'hazelcast.ignoreXxeProtectionFailures', true
}

integrationTest {
  testlogger {
    showPassed false
  }
}
